import groovy.transform.Field
import groovy.io.FileType

def projectJson = file('scripts/project.json')
def project = new groovy.json.JsonSlurper().parseText(projectJson.text)

def applicationName = project.applicationName
def version = project.version
def jhipsterVersion = project.jhipsterVersion

def jhipsterDownloadPath = project.jhipsterDownloadPath	
def url = jhipsterDownloadPath + 'v' + jhipsterVersion
	
def tempDir = rootDir.toString() + project.tempDir
def tempZipFile = rootDir.toString() + project.tempDir + '/sample.zip'

@Field skippedResources = []

tasks.register('upgrade') {

    doFirst {
	
		println ''
		println "Start upgrade application ${applicationName} to JHipster ${jhipsterVersion}"
		println ''	
		println "Download sample project from url: $url"
				
	}	

	dependsOn('unzipFile')
	
	doLast {      

		renameSampleProject(tempDir, jhipsterVersion)
		searchAndReplace(tempDir)
		upgradeProject(tempDir, project)
		upgradeBackend(tempDir, project)
		upgradeFrontend(tempDir, project)
		skippedResourcesReport()	
		
		printMessage('Upgrade finished')
		
    }
}

task deleteTempDir() {
  ant.delete(dir: tempDir)
}

task downloadZipFile(dependsOn: deleteTempDir, type: Download) {
	src url
	dest new File(tempZipFile)
}

task unzipFile(dependsOn: downloadZipFile, type: Copy) {
	from zipTree(tempZipFile)
	into tempDir
}

def renameSampleProject(tempDir, jhipsterVersion){
	
	def baseDir = "${tempDir}/gateway"

	file("${tempDir}/jhipster-sample-app-${jhipsterVersion}").renameTo(file(baseDir))

	def dir = new File("${baseDir}/src/main/java/io/github/jhipster/sample/")
	dir.eachFile() {		
		ant.move file: it, todir: "${baseDir}/src/main/java/org/assimbly/gateway"
	}

}

def searchAndReplace(tempDir){

	def baseDir = new File("${tempDir}/gateway")
	
	println "updating temp files..."
		
	baseDir.eachFileRecurse FileType.FILES,  { it ->
		def f = it.toString()
	
		ant.replace(file: it, token: "JhipsterSampleApplication", value: "Gateway")
		ant.replace(file: it, token: "jhipsterSampleApplication", value: "gateway")
		ant.replace(file: it, token: "jhipstersampleapplication", value: "gateway")
		ant.replace(file: it, token: "jhipster-sample-application", value: "gateway")
		ant.replace(file: it, token: "io.github.jhipster.sample", value: "org.assimbly.gateway")
		ant.replace(file: it, token: "io/github/jhipster/sample", value: "org/assimbly.gateway")
		
	}
}

def upgradeProject(tempDir, project){

	def path = rootDir.toString() + project.projectResources.basePath
	def tempPath = tempDir + "/" + project.applicationName + project.projectResources.basePath
	def resources = project.projectResources.resources

	printMessage('upgrade base project:')
	
	resources.each {
		applyAction(tempPath, path, it)	
	}
	
}

def upgradeBackend(tempDir, project){
	def path = rootDir.toString() + project.backendResources.basePath + "/"
	def testPath = rootDir.toString() + project.testBackendReSecources.basePath  + "/"
	
	def tempPath = tempDir + "/" + project.applicationName + project.backendResources.basePath + "/"
	def tempTestPath = tempDir + "/" + project.applicationName + project.testBackendReSecources.basePath  + "/"
	
	def resources = project.backendResources.resources
	def testResources = project.testBackendReSecources.resources
	
	printMessage('Upgrade backend:')
		
	resources.each {
		applyAction(tempPath, path, it)	
	}

	testResources.each {
		applyAction(tempTestPath, testPath, it)	
	}
	
}

def upgradeFrontend(tempDir, project){
	def path = rootDir.toString() + project.frontendResources.basePath + "/"
	def testPath = rootDir.toString() + project.testFrontendResources.basePath + "/"

	def tempPath = tempDir  + "/" + project.applicationName + project.frontendResources.basePath + "/"
	def tempTestPath = tempDir  + "/" + project.applicationName + project.testFrontendResources.basePath + "/"

	def resources = project.frontendResources.resources
	def testResources = project.testFrontendResources.resources	
	
	printMessage('Upgrade frontend:')
	
	resources.each {
		applyAction(tempPath, path, it)	
	}

	testResources.each {
		applyAction(tempTestPath, testPath, it)	
	}
}

def applyAction(tempPath, path, resource){

	def sourcePath = tempPath + resource.path
	def targetPath = path + resource.path
	
	if(resource.action.equals('delete')){
		deleteResource(targetPath, resource.type)
	} else if(resource.action.equals('replace')){
		replaceResource(sourcePath,targetPath, resource.type)
	} else if(resource.action.equals('skip')){
		skipResource(targetPath)
	}
	
}

def deleteResource(targetPath, type){
	
	printMessage('delete --> ' + targetPath)
	
	/*
	if(type.equals('dir')){
		ant.delete(dir: targetPath)
	}else{
		ant.delete(file: targetPath)
	}
	*/
	
}

def replaceResource(sourcePath, targetPath, type){	
	
	println ''
	println 'replace --> '
	println 'sourcepath: ' + sourcePath
	println 'targetPath: ' + targetPath
	println ''
		
	File sourcePathExist = new File(sourcePath)
	
	/*
	if(sourcePathExist.exists()){
	
		if(type.equals('dir')){
			ant.delete(dir: targetPath)
			targetPath = targetPath.substring(0, targetPath.lastIndexOf("/"))
			ant.move file: "${sourcePath}", todir: "${targetPath}"
		}else{
			ant.delete(file: targetPath)
			targetPath = targetPath.substring(0, targetPath.lastIndexOf("/"))
			ant.move file: "${sourcePath}", todir: "${targetPath}"
		}	
	}else{
		printMessage("warning file doesn't exist: ${sourcePath}")
	}*/
	
}

def skipResource(targetPath){
	skippedResources.push(targetPath)
}

def skippedResourcesReport(){

	printMessage('The follow resources were skipped (and maybe checked manually):')

	skippedResources.each {
		println it
	}
}

def printMessage(message){
	println ''
	println message
	println ''
}

